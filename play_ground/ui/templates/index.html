<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S3 Image Downloader & Comparison UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
    <div class="container">
        <h2 class="mb-4">S3 Image Downloader & Comparison Tool</h2>

        <!-- Initial Prompt -->
        <div id="initialPrompt">
            <p class="mb-3">Do you want to download images from S3?</p>
            <button class="btn btn-success me-2" onclick="handleDecision(true)">Yes</button>
            <button class="btn btn-secondary" onclick="handleDecision(false)">No</button>
        </div>

        <!-- S3 Download Section -->
        <div id="downloadSection" style="display:none;">
            <form id="jsonForm" class="mt-4">
                <div class="mb-3">
                    <label class="form-label">Upload JSON Config</label>
                    <input type="file" name="jsonFile" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary">Upload JSON</button>
            </form>

            <button id="downloadBtn" class="btn btn-success mt-3">Download from S3</button>
            <div id="status" class="mt-3 fw-bold text-info"></div>
        </div>

        <!-- Folder Selection Section -->
        <div id="folderSection" class="mt-4" style="display:none;">
            <h5>Select Folders:</h5>
            <button onclick="selectFolder('ground')" class="btn btn-secondary mb-2">Select Ground Truth Folder</button>
            <p id="groundPath"></p>

            <button onclick="selectFolder('synthetic')" class="btn btn-secondary mt-2">Select Synthetic Crops Folder</button>
            <p id="syntheticPath"></p>
        </div>

        <!-- Compare Section -->
        <div id="compareSection" class="mt-4" style="display:none;">
            <button id="compareBtn" class="btn btn-warning">Compare</button>
            <div id="compareStatus" class="mt-2 fw-bold text-info"></div>
        </div>

        <!-- Visualization Folder Selection -->
        <div id="visualizeSection" class="mt-4" style="display:none;">
            <button onclick="selectFolder('visualize')" class="btn btn-info">Select Folder to Visualize Images</button>
            <p id="visualizePath"></p>
        </div>
    </div>

    <script>
        let selectedGround = false;
        let selectedSynthetic = false;

        function handleDecision(wantsDownload) {
            document.getElementById("initialPrompt").style.display = "none";
            if (wantsDownload) {
                document.getElementById("downloadSection").style.display = "block";
            } else {
                document.getElementById("folderSection").style.display = "block";
            }
        }

        function checkFolderSelections() {
            if (selectedGround && selectedSynthetic) {
                document.getElementById("compareSection").style.display = "block";
            }
        }

        function selectFolder(type) {
            fetch('/select-folder')
                .then(res => res.json())
                .then(data => {
                    const path = data.folderPath || "No folder selected.";
                    if (type === 'ground') {
                        document.getElementById("groundPath").innerText = path;
                        selectedGround = true;
                    } else if (type === 'synthetic') {
                        document.getElementById("syntheticPath").innerText = path;
                        selectedSynthetic = true;
                    } else if (type === 'visualize') {
                        document.getElementById("visualizePath").innerText = path;
                    }
                    checkFolderSelections();
                });
        }

        document.getElementById("jsonForm").addEventListener("submit", function (e) {
            e.preventDefault();
            let formData = new FormData(this);

            fetch('/upload-json', {
                method: 'POST',
                body: formData
            }).then(res => res.json())
              .then(data => alert(data.message));
        });

        document.getElementById("downloadBtn").addEventListener("click", () => {
            document.getElementById("status").innerText = "Downloading from S3...";
            fetch('/start-download', { method: 'POST' });

            let check = setInterval(() => {
                fetch('/check-status')
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "completed") {
                            clearInterval(check);
                            document.getElementById("status").innerText = "✅ Download completed successfully!";
                            document.getElementById("folderSection").style.display = 'block';
                        }
                    });
            }, 1000);
        });

        document.getElementById("compareBtn").addEventListener("click", () => {
            document.getElementById("compareStatus").innerText = "Comparing images...";
            setTimeout(() => {
                document.getElementById("compareStatus").innerText = "✅ Comparison completed!";
                document.getElementById("visualizeSection").style.display = "block";
            }, 4000);
        });
    </script>
</body>
</html>